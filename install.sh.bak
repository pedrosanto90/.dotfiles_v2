#!/bin/bash

# Este script instala e configura um ambiente de desenvolvimento completo
# no Debian 13 (Trixie).
# Deve ser executado com 'sudo ./install.sh' ou 'wget | sudo sh'.

# --- VARIAVEIS ESSENCIAIS ---
# Obt√©m o nome do utilizador original que invocou o 'sudo'
USER_NAME=$(logname 2>/dev/null || echo ${SUDO_USER}) 
if [ -z "$USER_NAME" ]; then
    echo "Erro: O script deve ser executado com 'sudo'."
    exit 1
fi
HOME_DIR="/home/$USER_NAME" 
DOTFILES_REPO="https://github.com/pedrosanto90/.dotfiles_v2"
DOTFILES_DIR="$HOME_DIR/.dotfiles_v2" # Reposit√≥rio clonado

# Vers√µes e URLs
DEB_OBSIDIAN_URL="https://github.com/obsidianmd/obsidian-releases/releases/download/v1.6.3/obsidian-1.6.3.deb"
DEB_ONLYOFFICE_URL="https://download.onlyoffice.com/install/desktop/editors/linux/onlyoffice-desktopeditors_amd64.deb"
DEB_WEBEX_URL="https://binaries.webex.com/WebexDesktopApp-linux-webex.deb"
DEB_DBEAVER_URL="https://dbeaver.io/files/dbeaver-ce_latest_amd64.deb"
BITWARDEN_APPIMAGE_URL="https://vault.bitwarden.com/download/?app=desktop&platform=linux&variant=appimage"
POSTMAN_TAR_URL="https://dl.pstmn.io/download/latest/linux_64"
INSOMNIA_DEB_URL="https://insomnia.rest/download/core/debian"

# Garante que o script √© executado como root
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, execute como root (sudo ./install.sh)"
  exit 1
fi

echo "Inicializando a configura√ß√£o para o utilizador: $USER_NAME"
echo "---------------------------------------------------------"

# 1. Configurar Reposit√≥rios (CORRIGIDO: sources.list limpo)
echo "1. Corrigindo /etc/apt/sources.list e atualizando para Trixie..."
cat << EOF > /etc/apt/sources.list
# Reposit√≥rios Debian 13 (Trixie)
deb http://deb.debian.org/debian/ trixie main contrib non-free non-free-firmware
deb http://deb.debian.org/debian/ trixie-updates main contrib non-free non-free-firmware
deb http://security.debian.org/debian-security/ trixie-security main contrib non-free non-free-firmware
EOF

apt clean
apt update -y
apt upgrade -y

# 2. Configura√ß√µes de Diret√≥rios e Estrutura (Executado como utilizador)
echo "2. Criando a estrutura de diret√≥rios padr√£o..."
su - "$USER_NAME" -c "
  cd \"$HOME_DIR\"
  mkdir -p .config scripts Documents Downloads Pictures Music Videos
  mkdir -p Documents/projects
  mkdir -p Documents/work/domatica
"

# 3. Instala√ß√£o de Core System e Ferramentas (APT)
echo "3. Instala√ß√£o de Core System, i3, ZSH e Utilidades essenciais..."
apt install -y \
  xserver-xorg i3 i3status rofi dmenu fzf lightdm tmux nitrogen \
  zsh git curl wget build-essential cmake make ninja-build pkg-config libtool libtool-bin gettext unzip \
  network-manager network-manager-gnome network-manager-openvpn network-manager-openvpn-gnome \
  gvfs-backends blueman chromium x11-xserver-utils maim xclip pulseaudio-utils brightnessctl \
  arandr eza bat \
  npm python3 python3-pip
# gvfs-smb 

systemctl enable lightdm

# 4. Instalar Docker e Configurar Permiss√µes (L√≥gica Upstream Mantida)
echo "4. Instalando e configurando Docker (M√©todo Oficial)..."
# Adicionar depend√™ncias para Docker
apt install ca-certificates gnupg lsb-release
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc
# Adicionar reposit√≥rio
tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/debian
Suites: $(. /etc/os-release && echo "$VERSION_CODENAME")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF

apt update -y
apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl start docker.service
systemctl enable docker.service

# Configurar Permiss√µes do Docker
groupadd docker 2>/dev/null || true
usermod -aG docker "$USER_NAME"

# 5. Instalar VS Code e WezTerm (via Reposit√≥rio Upstream)
echo "5. Instalando VS Code e WezTerm via reposit√≥rio..."
# VS Code
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/
rm packages.microsoft.gpg
echo "deb [arch=amd64] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list

# WezTerm - L√≥gica de Reposit√≥rio Fury Mantida
echo '-> Instalando WezTerm via reposit√≥rio Fury...'
curl -fsSL https://apt.fury.io/wez/gpg.key | gpg --yes --dearmor -o /usr/share/keyrings/wezterm-fury.gpg
echo 'deb [signed-by=/usr/share/keyrings/wezterm-fury.gpg] https://apt.fury.io/wez/ * *' | tee /etc/apt/sources.list.d/wezterm.list
chmod 644 /usr/share/keyrings/wezterm-fury.gpg

apt update -y
apt install -y code wezterm

# 6. Instalar Neovim a partir do C√≥digo Fonte (Latest Master)
echo "6. Instalando Neovim (Latest Master) a partir do C√≥digo Fonte..."
git clone https://github.com/neovim/neovim /opt/neovim-src
cd /opt/neovim-src
make CMAKE_BUILD_TYPE=Release
make install
cd "$SCRIPT_DIR"

# 7. Instalar Aplica√ß√µes (.deb e Bin√°rios)
echo "7. Instalando pacotes .deb (Obsidian, OnlyOffice, Webex, DBeaver) e bin√°rios..."
# .deb packages
wget -O /tmp/obsidian.deb "$DEB_OBSIDIAN_URL" && dpkg -i /tmp/obsidian.deb
wget -O /tmp/onlyoffice.deb "$DEB_ONLYOFFICE_URL" && dpkg -i /tmp/onlyoffice.deb
wget -O /tmp/webex.deb "$DEB_WEBEX_URL" && dpkg -i /tmp/webex.deb
wget -O /tmp/insomnia.deb "$INSOMNIA_DEB_URL" && dpkg -i /tmp/insomnia.deb
wget -O /tmp/dbeaver.deb "$DEB_DBEAVER_URL" && dpkg -i /tmp/dbeaver.deb

# Corrigir depend√™ncias (essencial ap√≥s dpkg -i)
apt --fix-broken install -y

# Bin√°rios/AppImages
INSTALL_DIR="/opt/binaries"
mkdir -p "$INSTALL_DIR"

wget -O "$INSTALL_DIR/Bitwarden.AppImage" "$BITWARDEN_APPIMAGE_URL"
chmod +x "$INSTALL_DIR/Bitwarden.AppImage"

wget -O /tmp/postman.tar.gz "$POSTMAN_TAR_URL"
tar -xzf /tmp/postman.tar.gz -C "$INSTALL_DIR"
ln -sf "$INSTALL_DIR/Postman/Postman" /usr/local/bin/postman
rm /tmp/postman.tar.gz

# 8. Configurar Shell (ZSH/Oh-My-ZSH)
echo "8. Configurando ZSH e instalando Oh-My-ZSH..."
chsh -s "$(which zsh)" "$USER_NAME"
su - "$USER_NAME" -c "sh -c \"$(wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O - --no-check-certificate)\""

# 9. Configura√ß√£o de Dotfiles (Symlinks Automatizada)
echo "9. Automatizando a cria√ß√£o de Symlinks para Dotfiles..."
# CLONAR REPOSIT√ìRIO (Corre na primeira parte do bloco su -c)
su - "$USER_NAME" -c "
  git clone \"$DOTFILES_REPO\" \"$DOTFILES_DIR\"

  mkdir -p \"\$HOME_DIR/.config\"
  
  # 9.1 Limpeza ZSH: Remover ficheiros de configura√ß√£o ZSH existentes
  echo '  -> Limpeza: Removendo ficheiros ZSH existentes...'
  rm -rf \"\$HOME_DIR/.zshrc\"
  rm -rf \"\$HOME_DIR/.zprofile\"
  rm -rf \"\$HOME_DIR/.zsh_history\"

  # 9.2 Cria√ß√£o de Symlinks
  echo '  -> Criando symlinks...'
  ln -sfn \"$DOTFILES_DIR/.config/i3\" \"\$HOME_DIR/.config/i3\"
  ln -sfn \"$DOTFILES_DIR/.config/i3status\" \"\$HOME_DIR/.config/i3status\"
  ln -sfn \"$DOTFILES_DIR/.config/nvim\" \"\$HOME_DIR/.config/nvim\"
  ln -sfn \"$DOTFILES_DIR/.config/tmux\" \"\$HOME_DIR/.config/tmux\"
  ln -sfn \"$DOTFILES_DIR/.config/wezterm\" \"\$HOME_DIR/.config/wezterm\"

  # Ficheiros e scripts de topo
  ln -sfn \"$DOTFILES_DIR/zsh/.zshrc\" \"\$HOME_DIR/.zshrc\"
  ln -sfn \"$DOTFILES_DIR/zsh/.zprofile\" \"\$HOME_DIR/.zshprofile\"
  ln -sfn \"$DOTFILES_DIR/scripts\" \"\$HOME_DIR/scripts\"
  ln -sfn \"$DOTFILES_DIR/wallpapper/lofi-bart.jpg\" \"\$HOME_DIR/Pictures/lofi-bart.jpg\"
"

# 10. Configurar Ambiente Node.js (NVM, Node v22, NestJS, Angular)
echo "10. Configurando Ambiente Node.js (NVM, Node v22, NestJS, Angular)..."
su - "$USER_NAME" -c "
  echo '  -> Instalando NVM (v0.39.5)...'
  # 10.1 Instalar NVM
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash

  # 10.2 Carregar NVM para o shell atual do subshell
  export NVM_DIR=\"\$HOME/.nvm\"
  [ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"

  # 10.3 Instalar e Definir Node.js v22 como padr√£o
  echo '  -> Instalando Node.js v22 e definindo como padr√£o...'
  nvm install 22
  nvm alias default 22

  # 10.4 Instalar CLIs Globais
  echo '  -> Instalando CLIs Globais: NestJS e Angular...'
  npm install -g @nestjs/cli @angular/cli

  echo '  -> Node.js v22, NestJS CLI e Angular CLI instalados com sucesso.'
"

# 11. Configura√ß√£o Interativa do Git
echo "11. Configura√ß√£o Interativa do Git (user.name e user.email)..."
# 11.1 Criar o script de configura√ß√£o
echo "  -> Criando o script de configura√ß√£o do Git em $HOME_DIR/scripts/git_config.sh"
su - "$USER_NAME" -c "
cat << 'GIT_CONFIG_EOF' > \"\$HOME_DIR/scripts/git_config.sh\"
#!/bin/bash
echo \"\"
echo \"--- Configura√ß√£o Global do Git ---\"
echo \"Por favor, introduza a informa√ß√£o para a identifica√ß√£o das suas contribui√ß√µes.\"

read -r -p \"Introduza o seu Nome Completo: \" GIT_NAME
if [ -z \"\$GIT_NAME\" ]; then
    echo \"Nome n√£o fornecido. A configura√ß√£o do Git foi cancelada.\"
    exit 1
fi

read -r -p \"Introduza o seu Email: \" GIT_EMAIL
if [ -z \"\$GIT_EMAIL\" ]; then
    echo \"Email n√£o fornecido. A configura√ß√£o do Git foi cancelada.\"
    exit 1
fi

git config --global user.name \"\$GIT_NAME\"
echo \"‚úÖ Nome de utilizador Git configurado: \$GIT_NAME\"

git config --global user.email \"\$GIT_EMAIL\"
echo \"‚úÖ Email Git configurado: \$GIT_EMAIL\"

git config --global core.editor \"nvim\"
echo \"‚úÖ Editor Git configurado para Neovim.\"

echo \"--- Configura√ß√£o Git Conclu√≠da ---\"
GIT_CONFIG_EOF
chmod +x \"\$HOME_DIR/scripts/git_config.sh\"
"

# 11.2 Executar o script de configura√ß√£o do Git (interativo - REQUER INPUT)
echo ""
echo "!!! ATEN√á√ÉO: IN√çCIO DA CONFIGURA√á√ÉO INTERATIVA DO GIT !!!"
echo "Por favor, introduza o seu Nome Completo e Email quando solicitado."
echo "----------------------------------------------------------------------------------"
su - "$USER_NAME" -c "$HOME_DIR/scripts/git_config.sh"
echo "----------------------------------------------------------------------------------"

# 12. Finaliza√ß√£o
echo "---------------------------------------------------------"
echo "‚úÖ Instala√ß√£o e Configura√ß√£o conclu√≠da! üéâ"
echo ""
echo "!!! AVISO IMPORTANTE !!!"
echo "Para que as permiss√µes do Docker, o novo ambiente ZSH e o NVM entrem em vigor,"
echo "o utilizador $USER_NAME deve fazer **LOGOUT e LOGIN** ou **REINICIAR** a m√°quina."
echo ""
echo "Recomenda√ß√£o: Reinicie a m√°quina (shutdown -r now) para garantir que tudo inicia corretamente."

exit 0
